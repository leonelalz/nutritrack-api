# ğŸ¯ CÃ“MO FUNCIONA EL PROYECTO NUTRITRACK

> **Documento GuÃ­a para ReconstrucciÃ³n del Proyecto**  
> Este documento explica la lÃ³gica de negocio, arquitectura y flujo de datos del sistema NutriTrack.  
> Ãšsalo como referencia cada vez que necesites recordar cÃ³mo funciona el proyecto completo.

---

## ğŸ“‹ TABLA DE CONTENIDOS

1. [Concepto General del Sistema](#concepto-general-del-sistema)
2. [Arquitectura de 5 MÃ³dulos](#arquitectura-de-5-mÃ³dulos)
3. [Flujo de Datos Completo](#flujo-de-datos-completo)
4. [Estructura de Base de Datos](#estructura-de-base-de-datos)
5. [Modelo de Negocio](#modelo-de-negocio)
6. [Casos de Uso Principales](#casos-de-uso-principales)
7. [Diferencias Clave vs Otros Sistemas](#diferencias-clave-vs-otros-sistemas)
8. [Reglas de Negocio CrÃ­ticas](#reglas-de-negocio-crÃ­ticas)
9. [Resumen Ejecutivo](#resumen-ejecutivo)
10. [Referencias TÃ©cnicas](#referencias-tÃ©cnicas)

---

## ğŸš€ FLUJO DE TRABAJO DEL EQUIPO

### Para Iniciar el Proyecto (Orden Recomendado)

1. **LEER ESTA GUÃA COMPLETA** - Entender el modelo de negocio
2. **REVISAR USER_STORIES.MD** - Entender QUÃ‰ debe hacer el sistema
3. **REVISAR REGLAS_NEGOCIO.MD** - Entender CÃ“MO debe comportarse
4. **VERIFICAR BASE DE DATOS** - Confirmar que NutriDB.sql tiene todas las tablas (ya verificado âœ…)
5. **IMPLEMENTAR POR MÃ“DULOS** - Seguir la asignaciÃ³n de responsabilidades

### Ciclo de Desarrollo por User Story

```
1. Leer User Story (USER_STORIES.MD)
2. Identificar Reglas de Negocio relacionadas (REGLAS_NEGOCIO.MD)
3. Crear DTOs con validaciones Bean Validation
4. Implementar Service con lÃ³gica de negocio
5. Crear Controller con endpoints REST
6. Escribir tests unitarios
7. Verificar contra criterios de aceptaciÃ³n
```

### Prioridad de ImplementaciÃ³n

ğŸš¨ **CRÃTICO** - Implementar primero (riesgo de seguridad/datos):
- RN16: Filtrar catÃ¡logo por alergias (SEGURIDAD DE SALUD)
- RN07, RN08, RN09: Integridad de datos (nombres Ãºnicos, no eliminar en uso)

ğŸŸ¡ **ALTA** - Implementar segundo:
- RN14: No eliminar planes con usuarios activos
- US-01 a US-05: Sistema de autenticaciÃ³n

ğŸŸ¢ **MEDIA** - Implementar despuÃ©s:
- MÃ³dulos 2 y 3: Biblioteca de contenido y catÃ¡logo
- MÃ³dulos 4 y 5: Funcionalidades de cliente

---

## ğŸŒŸ CONCEPTO GENERAL DEL SISTEMA

### Â¿QuÃ© es NutriTrack?

**NutriTrack es una plataforma SaaS de coaching nutricional y fitness** que permite a los usuarios:

1. **Configurar su perfil de salud** (objetivos, nivel de actividad, alergias, condiciones mÃ©dicas)
2. **Escoger PLANES completos** (no actividades sueltas):
    - **Planes de AlimentaciÃ³n** con duraciÃ³n fija (ej: 30 dÃ­as)
    - **Rutinas de Ejercicio** con duraciÃ³n fija (ej: 12 semanas)
3. **Seguir actividades diarias programadas** que el plan les indica
4. **Registrar lo que realmente hacen** dÃ­a a dÃ­a
5. **Ver su progreso** comparando lo planeado vs lo real

### Concepto Clave: Planes como Objetivos con Actividades

```
USUARIO ESCOGE â†’ PLAN (Objetivo con duraciÃ³n fija)
                    â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                     â”‚
    PLAN ALIMENTACIÃ“N    RUTINA EJERCICIO
    (30 dÃ­as)            (12 semanas)
         â”‚                     â”‚
         â†“                     â†“
    ACTIVIDADES DIARIAS  ACTIVIDADES DIARIAS
    (QuÃ© comer cada dÃ­a) (QuÃ© ejercicios hacer)
         â”‚                     â”‚
         â†“                     â†“
    REGISTRO REAL        REGISTRO REAL
    (QuÃ© comiÃ³)          (QuÃ© ejercicio hizo)
         â”‚                     â”‚
         â†“                     â†“
    MÃ‰TRICAS DE PROGRESO
    (Adherencia, calorÃ­as, peso)
```

---

## ğŸ—ï¸ ARQUITECTURA DE 5 MÃ“DULOS

### MÃ“DULO 1: AUTENTICACIÃ“N Y PERFILES

**PropÃ³sito:** Gestionar usuarios y su informaciÃ³n de salud

```
roles (ROLE_USER, ROLE_ADMIN)
  â†“
cuentas_auth (email, password, activo)
  â†“
perfiles_usuario (nombre, apellido, unidades_medida: KG/LBS)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   â”‚
usuario_perfil_salud         usuario_historial_medidas
(objetivo, nivel_actividad)  (peso, altura, IMC por fecha)
â”‚
usuario_etiquetas_salud
(alergias, condiciones mÃ©dicas)
```

**Tablas:**
- `roles`: Solo 2 roles (ROLE_USER, ROLE_ADMIN)
- `cuentas_auth`: AutenticaciÃ³n (email Ãºnico, password, JWT)
- `perfiles_usuario`: Datos personales (1-to-1 con cuentas_auth)
- `usuario_perfil_salud`: ConfiguraciÃ³n de salud (1-to-1 con perfiles_usuario)
    - `objetivo_actual`: PERDER_PESO | GANAR_MASA_MUSCULAR | MANTENER_FORMA | REHABILITACION | CONTROLAR_ESTRES
    - `nivel_actividad_actual`: BAJO | MODERADO | ALTO
- `usuario_historial_medidas`: HistÃ³rico de medidas corporales
- `usuario_etiquetas_salud`: Etiquetas del usuario (many-to-many con etiquetas)

**Punto Clave:** Un usuario puede tener mÃºltiples registros de medidas (peso, altura) en el tiempo para hacer seguimiento de progreso.

---

### MÃ“DULO 2: BIBLIOTECA DE CONTENIDO

**PropÃ³sito:** CatÃ¡logo reutilizable de ingredientes, comidas y ejercicios

```
etiquetas (sistema de categorizaciÃ³n universal)
    â†“
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               â”‚              â”‚
ingredientes    comidas     ejercicios
    â†“               â†“
etiquetas_      recetas
ingredientes    (comida + ingrediente + cantidad)
```

#### 2.1. Sistema de Etiquetas (CategorizaciÃ³n Universal)

**Tabla:** `etiquetas`

**Tipos de Etiquetas (7 categorÃ­as):**
```sql
tipo_etiqueta VARCHAR(50) CHECK IN (
  'ALERGIA',           -- Gluten, Lactosa, ManÃ­
  'CONDICION_MEDICA',  -- Diabetes, HipertensiÃ³n, CelÃ­aco
  'OBJETIVO',          -- PÃ©rdida de peso, Ganancia muscular
  'DIETA',             -- Vegana, Vegetariana, Keto, Paleo
  'DIFICULTAD',        -- Principiante, Intermedio, Avanzado
  'GRUPO_MUSCULAR',    -- Pecho, Espalda, Piernas
  'TIPO_EJERCICIO'     -- Cardio, Fuerza, HIIT, Yoga
)
```

**Ventaja:** Una sola tabla categoriza usuarios, ingredientes, comidas, ejercicios, planes y rutinas.

#### 2.2. Ingredientes

**Tabla:** `ingredientes`

**Campos Clave:**
- InformaciÃ³n nutricional (por 100g): `proteinas`, `carbohidratos`, `grasas`, `energia`
- `grupo_alimenticio`: FRUTAS | VERDURAS | CEREALES | LEGUMBRES | PROTEINAS_ANIMALES | PROTEINAS_VEGETALES | LACTEOS | GRASAS_SALUDABLES | AZUCARES | BEBIDAS | CONDIMENTOS | FRUTOS_SECOS | OTRO

**Relaciones:**
- `etiquetas_ingredientes`: Many-to-many con etiquetas (ej: Leche â†’ etiqueta "Lactosa")

#### 2.3. Comidas

**Tabla:** `comidas`

**Campos Clave:**
- `tipo_comida`: DESAYUNO | ALMUERZO | CENA | SNACK | PRE_ENTRENAMIENTO | POST_ENTRENAMIENTO | COLACION
- `tiempo_elaboracion`: Minutos de preparaciÃ³n

**Tabla:** `recetas` (ComposiciÃ³n de comidas)

```
Receta = Comida + Ingrediente + Cantidad
```

**Composite Key:** `(id_comida, id_ingrediente)`

**Ejemplo:**
```sql
-- Comida: "Ensalada CÃ©sar"
-- Receta:
id_comida=1, id_ingrediente=5 (Lechuga),     cantidad=100.00 (gramos)
id_comida=1, id_ingrediente=12 (Pollo),      cantidad=150.00 (gramos)
id_comida=1, id_ingrediente=23 (Parmesano),  cantidad=30.00 (gramos)
id_comida=1, id_ingrediente=45 (Aceite),     cantidad=15.00 (ml)
```

**Punto Clave:** Las calorÃ­as de una comida se calculan sumando los macros de todos sus ingredientes segÃºn las cantidades.

#### 2.4. Ejercicios

**Tabla:** `ejercicios`

**Campos Clave:**
- `tipo_ejercicio`: CARDIO | FUERZA | FLEXIBILIDAD | EQUILIBRIO | HIIT | YOGA | PILATES | FUNCIONAL | DEPORTIVO | OTRO
- `musculo_principal`: PECHO | ESPALDA | HOMBROS | BRAZOS | BICEPS | TRICEPS | ABDOMINALES | PIERNAS | CUADRICEPS | GLUTEOS | GEMELOS | CARDIO | CUERPO_COMPLETO | CORE | OTRO
- `dificultad`: PRINCIPIANTE | INTERMEDIO | AVANZADO | EXPERTO
- `calorias_estimadas`: CalorÃ­as por sesiÃ³n estÃ¡ndar
- `duracion`: DuraciÃ³n estÃ¡ndar en minutos

**Relaciones:**
- `etiquetas_ejercicios`: Many-to-many con etiquetas

---

### MÃ“DULO 3: PLANES NUTRICIONALES

**PropÃ³sito:** Planes de alimentaciÃ³n con duraciÃ³n fija y actividades diarias programadas

```
planes (objetivo general con duraciÃ³n)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            â”‚
plan_objetivos          plan_dias
(macros diarios)        (actividades diarias)
â”‚                            â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚                       â”‚           â”‚
plan_etiquetas         comida    numero_dia
(clasificaciÃ³n)        (catÃ¡logo) (1 a N)
```

#### 3.1. Tabla: `planes`

**Concepto:** Un plan es un OBJETIVO CON DURACIÃ“N FIJA que contiene actividades diarias programadas.

**Campos Clave:**
- `nombre`: "Plan PÃ©rdida de Peso 30 dÃ­as"
- `descripcion`: DescripciÃ³n del plan
- `duracion_dias`: DuraciÃ³n total (ej: 30 dÃ­as)
- `activo`: Si estÃ¡ disponible para asignar

**NO es:** Un catÃ¡logo de "metas sueltas"  
**SÃ es:** Un programa completo dÃ­a a dÃ­a

#### 3.2. Tabla: `plan_objetivos` (1-to-1 con planes)

**Concepto:** Objetivos nutricionales DIARIOS del plan.

**Campos Clave:**
- `calorias_objetivo`: Meta diaria de calorÃ­as (ej: 1500)
- `proteinas_objetivo`: Gramos diarios (ej: 120)
- `carbohidratos_objetivo`: Gramos diarios (ej: 150)
- `grasas_objetivo`: Gramos diarios (ej: 50)

**Punto Clave:** Son objetivos diarios, NO totales del plan.

#### 3.3. Tabla: `plan_dias` (Actividades diarias)

**Concepto:** ProgramaciÃ³n diaria del plan. Define QUÃ‰ COMER CADA DÃA.

**Campos Clave:**
- `id_plan`: Plan al que pertenece
- `numero_dia`: DÃ­a del plan (1, 2, 3... hasta `duracion_dias`)
- `tipo_comida`: DESAYUNO | ALMUERZO | CENA | SNACK | etc.
- `id_comida`: QuÃ© comida del catÃ¡logo se debe consumir
- `notas`: Instrucciones adicionales

**Ejemplo Real:**
```
Plan: "Plan PÃ©rdida de Peso 30 dÃ­as"

DÃ­a 1:
  - DESAYUNO â†’ Avena con frutas (id_comida=15)
  - ALMUERZO â†’ Pollo con ensalada (id_comida=42)
  - CENA â†’ Pescado con verduras (id_comida=78)
  - SNACK â†’ Yogurt griego (id_comida=103)

DÃ­a 2:
  - DESAYUNO â†’ Huevos revueltos (id_comida=18)
  - ALMUERZO â†’ Pasta integral con atÃºn (id_comida=55)
  - ...

... (hasta DÃ­a 30)
```

**Punto Clave:** Un plan de 30 dÃ­as con 4 comidas diarias = 120 registros en `plan_dias`.

#### 3.4. Tabla: `plan_etiquetas` (ClasificaciÃ³n)

**Concepto:** Etiquetas del plan para filtrado y bÃºsqueda.

**Ejemplos:**
- Plan â†’ Etiqueta "PÃ©rdida de peso" (tipo: OBJETIVO)
- Plan â†’ Etiqueta "Dieta Vegana" (tipo: DIETA)
- Plan â†’ Etiqueta "1500 calorÃ­as" (tipo: OBJETIVO)
- Plan â†’ Etiqueta "Sin gluten" (tipo: ALERGIA)

---

### MÃ“DULO 4: RUTINAS DE EJERCICIO

**PropÃ³sito:** Rutinas de ejercicio con duraciÃ³n fija y actividades programadas

```
rutinas (objetivo general con duraciÃ³n)
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            â”‚
rutina_etiquetas      rutina_ejercicios
(clasificaciÃ³n)       (actividades programadas)
                             â”‚
                        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                        â”‚           â”‚
                     ejercicio    configuraciÃ³n
                     (catÃ¡logo)   (series, reps, peso)
```

#### 4.1. Tabla: `rutinas`

**Concepto:** Una rutina es un PROGRAMA DE EJERCICIO CON DURACIÃ“N FIJA.

**Campos Clave:**
- `nombre`: "Rutina Hipertrofia 12 Semanas"
- `descripcion`: DescripciÃ³n del programa
- `duracion_semanas`: DuraciÃ³n total (ej: 12 semanas)
- `activo`: Si estÃ¡ disponible para asignar

**Punto Clave:** A diferencia de planes (dÃ­as), rutinas usan SEMANAS como unidad.

#### 4.2. Tabla: `rutina_ejercicios` (Actividades programadas)

**Concepto:** Lista de ejercicios que componen la rutina con su configuraciÃ³n.

**Campos Clave:**
- `id_rutina`: Rutina a la que pertenece
- `id_ejercicio`: Ejercicio del catÃ¡logo
- `orden`: Secuencia de ejecuciÃ³n (1, 2, 3...)
- `series`: NÃºmero de series (ej: 4)
- `repeticiones`: Reps por serie (ej: 12)
- `peso`: Peso a utilizar en kg/lbs (opcional)
- `duracion_minutos`: DuraciÃ³n total del ejercicio
- `notas`: Instrucciones (ej: "Descanso 90 segundos entre series")

**Ejemplo Real:**
```
Rutina: "Rutina Hipertrofia 12 Semanas"

Ejercicio 1:
  - ejercicio: Press Banca (id_ejercicio=5)
  - orden: 1
  - series: 4
  - repeticiones: 12
  - peso: 60.00 kg
  - duracion_minutos: 15
  - notas: "Descanso 90 segundos"

Ejercicio 2:
  - ejercicio: Sentadilla (id_ejercicio=23)
  - orden: 2
  - series: 4
  - repeticiones: 10
  - peso: 100.00 kg
  - duracion_minutos: 20
  - notas: "Bajar hasta 90 grados"

Ejercicio 3:
  - ejercicio: Dominadas (id_ejercicio=8)
  - ...
```

**Punto Clave:** La rutina define el template, pero el usuario puede ajustar peso/reps cuando la ejecute.

#### 4.3. Tabla: `rutina_etiquetas` (ClasificaciÃ³n)

**Concepto:** Etiquetas de la rutina para filtrado.

**Ejemplos:**
- Rutina â†’ Etiqueta "Hipertrofia" (tipo: OBJETIVO)
- Rutina â†’ Etiqueta "Gimnasio" (tipo: TIPO_EJERCICIO)
- Rutina â†’ Etiqueta "Intermedio" (tipo: DIFICULTAD)
- Rutina â†’ Etiqueta "Pecho y Espalda" (tipo: GRUPO_MUSCULAR)

---

### MÃ“DULO 5: ASIGNACIÃ“N Y SEGUIMIENTO

**PropÃ³sito:** Usuarios activan planes/rutinas y registran su progreso diario

```
ASIGNACIÃ“N DE PLANES              ASIGNACIÃ“N DE RUTINAS
usuarios_planes                   usuarios_rutinas
  â†“                                  â†“
registros_comidas              registros_ejercicios
(quÃ© comiÃ³ realmente)          (quÃ© ejercicio hizo)
```

#### 5.1. Tabla: `usuarios_planes` (AsignaciÃ³n de Planes)

**Concepto:** Cuando un usuario ACTIVA un plan de alimentaciÃ³n.

**Campos Clave:**
- `id_perfil_usuario`: Usuario que activa el plan
- `id_plan`: Plan que se activa
- `fecha_inicio`: CuÃ¡ndo empieza
- `fecha_fin`: CuÃ¡ndo termina (calculado: fecha_inicio + duracion_dias)
- `dia_actual`: Progreso (en quÃ© dÃ­a va: 1, 2, 3... N)
- `estado`: ACTIVO | COMPLETADO | CANCELADO | PAUSADO
- `notas`: Observaciones del usuario

**Flujo:**
```
1. Usuario escoge plan de 30 dÃ­as
2. Sistema crea usuarios_planes:
   - fecha_inicio: 2025-11-01
   - fecha_fin: 2025-11-30
   - dia_actual: 1
   - estado: ACTIVO

3. Cada dÃ­a que pasa:
   - dia_actual se incrementa (2, 3, 4...)
   - Sistema muestra plan_dias WHERE numero_dia = dia_actual

4. Al completar 30 dÃ­as:
   - dia_actual: 30
   - estado: COMPLETADO
```

**Punto Clave:** Un usuario puede tener mÃºltiples asignaciones (historial de planes que ha seguido).

#### 5.2. Tabla: `registros_comidas` (Seguimiento de AlimentaciÃ³n)

**Concepto:** Registro REAL de lo que el usuario comiÃ³ cada dÃ­a.

**Campos Clave:**
- `id_perfil_usuario`: QuiÃ©n comiÃ³
- `id_comida`: QuÃ© comiÃ³
- `id_usuario_plan`: Plan activo (opcional, puede ser libre)
- `fecha`: CuÃ¡ndo comiÃ³
- `hora`: A quÃ© hora
- `tipo_comida`: DESAYUNO | ALMUERZO | CENA | SNACK
- `porciones`: CuÃ¡nto comiÃ³ (1.0, 1.5, 2.0 porciones)
- `calorias_consumidas`: CalorÃ­as totales (calculadas)
- `notas`: Observaciones

**Flujo:**
```
1. Sistema muestra plan del dÃ­a:
   DÃ­a 5 â†’ DESAYUNO: Avena con frutas

2. Usuario come y registra:
   - comida: Avena con frutas
   - fecha: 2025-11-05
   - hora: 08:30
   - tipo_comida: DESAYUNO
   - porciones: 1.0
   - calorias_consumidas: 350 (calculado automÃ¡ticamente)
   - id_usuario_plan: 42 (vinculado al plan activo)

3. Usuario puede registrar comidas NO planificadas:
   - Mismo flujo pero id_usuario_plan = NULL
```

**Punto Clave:**
- Si `id_usuario_plan` estÃ¡ presente â†’ Comida del plan
- Si `id_usuario_plan` es NULL â†’ Comida libre (fuera del plan)

#### 5.3. Tabla: `usuarios_rutinas` (AsignaciÃ³n de Rutinas)

**Concepto:** Cuando un usuario ACTIVA una rutina de ejercicio.

**Campos Clave:**
- `id_perfil_usuario`: Usuario que activa
- `id_rutina`: Rutina activada
- `fecha_inicio`: CuÃ¡ndo empieza
- `fecha_fin`: CuÃ¡ndo termina (fecha_inicio + duracion_semanas * 7)
- `semana_actual`: Progreso (en quÃ© semana va: 1, 2, 3... N)
- `estado`: ACTIVO | COMPLETADO | CANCELADO | PAUSADO
- `notas`: Observaciones

**Flujo:**
```
1. Usuario escoge rutina de 12 semanas
2. Sistema crea usuarios_rutinas:
   - fecha_inicio: 2025-11-01
   - fecha_fin: 2026-01-24 (12 semanas despuÃ©s)
   - semana_actual: 1
   - estado: ACTIVO

3. Cada semana:
   - semana_actual se incrementa (2, 3, 4...)
   - Sistema muestra ejercicios de la rutina

4. Al completar 12 semanas:
   - semana_actual: 12
   - estado: COMPLETADO
```

#### 5.4. Tabla: `registros_ejercicios` (Seguimiento de Ejercicio)

**Concepto:** Registro REAL de los ejercicios que el usuario hizo.

**Campos Clave:**
- `id_perfil_usuario`: QuiÃ©n hizo el ejercicio
- `id_ejercicio`: QuÃ© ejercicio
- `id_usuario_rutina`: Rutina activa (opcional)
- `fecha`: CuÃ¡ndo lo hizo
- `hora`: A quÃ© hora
- `series_realizadas`: CuÃ¡ntas series hizo
- `repeticiones_realizadas`: CuÃ¡ntas reps por serie
- `peso_utilizado`: Peso usado (kg o lbs)
- `duracion_minutos`: DuraciÃ³n total
- `calorias_quemadas`: CalorÃ­as estimadas
- `notas`: Observaciones

**Flujo:**
```
1. Sistema muestra rutina:
   Ejercicio 1: Press Banca (4 series x 12 reps @ 60kg)

2. Usuario entrena y registra:
   - ejercicio: Press Banca
   - fecha: 2025-11-05
   - hora: 18:00
   - series_realizadas: 4
   - repeticiones_realizadas: 12
   - peso_utilizado: 60.00 kg
   - duracion_minutos: 15
   - calorias_quemadas: 180
   - id_usuario_rutina: 15 (vinculado a rutina activa)

3. Usuario puede registrar ejercicios libres:
   - Mismo flujo pero id_usuario_rutina = NULL
```

**Punto Clave:**
- Si `id_usuario_rutina` estÃ¡ presente â†’ Ejercicio de la rutina
- Si `id_usuario_rutina` es NULL â†’ Ejercicio libre

---

## ğŸ”„ FLUJO DE DATOS COMPLETO

### Caso de Uso: Usuario Quiere Perder Peso

#### FASE 1: Registro e InicializaciÃ³n

```
1. Usuario crea cuenta
   â†’ INSERT INTO cuentas_auth
   â†’ INSERT INTO perfiles_usuario

2. Configurar perfil de salud
   â†’ INSERT INTO usuario_perfil_salud
     - objetivo_actual: PERDER_PESO
     - nivel_actividad_actual: MODERADO

3. Agregar condiciones mÃ©dicas/alergias
   â†’ INSERT INTO usuario_etiquetas_salud
     - Etiqueta: "Lactosa" (tipo: ALERGIA)
     - Etiqueta: "Diabetes Tipo 2" (tipo: CONDICION_MEDICA)

4. Registrar medidas iniciales
   â†’ INSERT INTO usuario_historial_medidas
     - peso: 85.00 kg
     - altura: 1.75 m
     - imc: 27.76 (calculado)
     - fecha_medicion: 2025-11-01
```

#### FASE 2: BÃºsqueda y ActivaciÃ³n de Plan

```
5. Usuario busca planes
   â†’ SELECT * FROM planes p
     JOIN plan_etiquetas pe ON p.id = pe.id_plan
     JOIN etiquetas e ON pe.id_etiqueta = e.id
     WHERE e.nombre IN ('PÃ©rdida de peso', 'Sin lactosa')
     AND p.activo = true

   Resultado: "Plan PÃ©rdida de Peso 30 dÃ­as" (id=5)

6. Ver detalle del plan
   â†’ SELECT * FROM plan_objetivos WHERE id_plan = 5
     - calorias_objetivo: 1500
     - proteinas_objetivo: 120
     - carbohidratos_objetivo: 150
     - grasas_objetivo: 50

   â†’ SELECT * FROM plan_dias WHERE id_plan = 5 ORDER BY numero_dia, tipo_comida
     Muestra 30 dÃ­as x 4 comidas = 120 actividades programadas

7. Usuario activa el plan
   â†’ INSERT INTO usuarios_planes
     - id_plan: 5
     - id_perfil_usuario: 42
     - fecha_inicio: 2025-11-01
     - fecha_fin: 2025-11-30
     - dia_actual: 1
     - estado: ACTIVO
```

#### FASE 3: Seguimiento DÃ­a a DÃ­a

```
8. Sistema muestra plan del dÃ­a actual (DÃ­a 1)
   â†’ SELECT pd.*, c.nombre, c.tipo_comida
     FROM plan_dias pd
     JOIN comidas c ON pd.id_comida = c.id
     WHERE pd.id_plan = 5 AND pd.numero_dia = 1
     ORDER BY CASE pd.tipo_comida
       WHEN 'DESAYUNO' THEN 1
       WHEN 'ALMUERZO' THEN 2
       WHEN 'CENA' THEN 3
       WHEN 'SNACK' THEN 4
     END

   Resultado:
   - DESAYUNO: Avena con frutas
   - ALMUERZO: Pollo con ensalada
   - CENA: Pescado con verduras
   - SNACK: Yogurt griego

9. Usuario come el desayuno
   â†’ INSERT INTO registros_comidas
     - id_perfil_usuario: 42
     - id_usuario_plan: 15 (plan activo)
     - id_comida: 25 (Avena con frutas)
     - fecha: 2025-11-01
     - hora: 08:30
     - tipo_comida: DESAYUNO
     - porciones: 1.0
     - calorias_consumidas: 350.00
     - notas: "AgreguÃ© arÃ¡ndanos extra"

10. Al final del dÃ­a, incrementar progreso
    â†’ UPDATE usuarios_planes
      SET dia_actual = 2
      WHERE id = 15

11. DÃ­a 2: Sistema muestra nuevas actividades
    â†’ SELECT ... WHERE numero_dia = 2
```

#### FASE 4: BÃºsqueda y ActivaciÃ³n de Rutina

```
12. Usuario busca rutinas
    â†’ SELECT * FROM rutinas r
      JOIN rutina_etiquetas re ON r.id = re.id_rutina
      JOIN etiquetas e ON re.id_etiqueta = e.id
      WHERE e.nombre IN ('PÃ©rdida de peso', 'Gimnasio')
      AND r.activo = true

    Resultado: "Rutina Cardio y Fuerza 8 Semanas" (id=3)

13. Ver ejercicios de la rutina
    â†’ SELECT re.*, ej.nombre, ej.tipo_ejercicio
      FROM rutina_ejercicios re
      JOIN ejercicios ej ON re.id_ejercicio = ej.id
      WHERE re.id_rutina = 3
      ORDER BY re.orden

    Resultado:
    - Ejercicio 1: Cinta 30min (Cardio)
    - Ejercicio 2: Press Banca 4x12
    - Ejercicio 3: Sentadilla 4x10
    - ...

14. Usuario activa la rutina
    â†’ INSERT INTO usuarios_rutinas
      - id_rutina: 3
      - id_perfil_usuario: 42
      - fecha_inicio: 2025-11-01
      - fecha_fin: 2025-12-27 (8 semanas)
      - semana_actual: 1
      - estado: ACTIVO

15. Usuario entrena
    â†’ INSERT INTO registros_ejercicios
      - id_perfil_usuario: 42
      - id_usuario_rutina: 8
      - id_ejercicio: 45 (Press Banca)
      - fecha: 2025-11-01
      - hora: 18:00
      - series_realizadas: 4
      - repeticiones_realizadas: 12
      - peso_utilizado: 60.00
      - duracion_minutos: 15
      - calorias_quemadas: 180.00
```

#### FASE 5: Seguimiento de Progreso

```
16. Usuario actualiza peso (cada semana)
    â†’ INSERT INTO usuario_historial_medidas
      - id_cliente: 42
      - peso: 83.00 kg (-2kg en 7 dÃ­as)
      - altura: 1.75 m
      - imc: 27.10
      - fecha_medicion: 2025-11-08

17. Sistema calcula adherencia al plan
    â†’ SELECT 
        COUNT(DISTINCT fecha) as dias_registrados,
        30 as dias_totales,
        (COUNT(DISTINCT fecha) * 100.0 / 30) as adherencia_porcentaje
      FROM registros_comidas
      WHERE id_usuario_plan = 15
      
    Resultado: 26 dÃ­as registrados = 86.7% adherencia

18. Sistema calcula calorÃ­as promedio
    â†’ SELECT AVG(calorias_consumidas) as promedio_calorias
      FROM registros_comidas
      WHERE id_usuario_plan = 15
      
    Resultado: 1520 calorÃ­as vs 1500 objetivo = +20 calorÃ­as/dÃ­a

19. GrÃ¡fica de progreso de peso
    â†’ SELECT fecha_medicion, peso, imc
      FROM usuario_historial_medidas
      WHERE id_cliente = 42
      ORDER BY fecha_medicion

    Resultado:
    - 2025-11-01: 85.00 kg, IMC 27.76
    - 2025-11-08: 83.00 kg, IMC 27.10
    - 2025-11-15: 82.00 kg, IMC 26.78
    - 2025-11-22: 81.00 kg, IMC 26.45
    - 2025-11-30: 80.00 kg, IMC 26.12 âœ… (-5kg logrado)

20. Al completar el plan
    â†’ UPDATE usuarios_planes
      SET estado = 'COMPLETADO', dia_actual = 30
      WHERE id = 15
```

---

## ğŸ“Š ESTRUCTURA DE BASE DE DATOS

### JerarquÃ­a de Tablas por MÃ³dulo

```
ğŸ“ MÃ“DULO 1: AUTENTICACIÃ“N Y PERFILES
â”œâ”€â”€ roles (2 registros fijos: ROLE_USER, ROLE_ADMIN)
â”œâ”€â”€ cuentas_auth (email, password, JWT)
â”œâ”€â”€ perfiles_usuario (1-to-1 con cuentas_auth)
â”œâ”€â”€ usuario_perfil_salud (1-to-1 con perfiles_usuario)
â”œâ”€â”€ usuario_historial_medidas (many-to-1 con perfiles_usuario)
â””â”€â”€ usuario_etiquetas_salud (many-to-many: usuarios â†â†’ etiquetas)

ğŸ“ MÃ“DULO 2: BIBLIOTECA DE CONTENIDO
â”œâ”€â”€ etiquetas (tabla maestra de categorizaciÃ³n)
â”œâ”€â”€ ingredientes
â”‚   â””â”€â”€ etiquetas_ingredientes (many-to-many)
â”œâ”€â”€ comidas
â”‚   â””â”€â”€ recetas (many-to-many con cantidades)
â””â”€â”€ ejercicios
    â””â”€â”€ etiquetas_ejercicios (many-to-many)

ğŸ“ MÃ“DULO 3: PLANES NUTRICIONALES
â”œâ”€â”€ planes (objetivos con duraciÃ³n)
â”œâ”€â”€ plan_objetivos (1-to-1 con planes)
â”œâ”€â”€ plan_dias (many-to-1 con planes)
â””â”€â”€ plan_etiquetas (many-to-many: planes â†â†’ etiquetas)

ğŸ“ MÃ“DULO 4: RUTINAS DE EJERCICIO
â”œâ”€â”€ rutinas (programas con duraciÃ³n)
â”œâ”€â”€ rutina_ejercicios (many-to-1 con rutinas)
â””â”€â”€ rutina_etiquetas (many-to-many: rutinas â†â†’ etiquetas)

ğŸ“ MÃ“DULO 5: ASIGNACIÃ“N Y SEGUIMIENTO
â”œâ”€â”€ usuarios_planes (asignaciÃ³n de planes)
â”‚   â””â”€â”€ registros_comidas (seguimiento diario)
â””â”€â”€ usuarios_rutinas (asignaciÃ³n de rutinas)
    â””â”€â”€ registros_ejercicios (seguimiento diario)
```

### Relaciones CrÃ­ticas

#### 1. Cascada de Usuario
```
cuentas_auth (DELETE)
  â†“ CASCADE
perfiles_usuario (DELETE)
  â†“ CASCADE
â”œâ”€â”€ usuario_perfil_salud (DELETE)
â”œâ”€â”€ usuario_historial_medidas (DELETE)
â”œâ”€â”€ usuarios_planes (DELETE)
â”‚   â†“ CASCADE
â”‚   registros_comidas (DELETE)
â””â”€â”€ usuarios_rutinas (DELETE)
    â†“ CASCADE
    registros_ejercicios (DELETE)
```

**Regla:** Si se elimina un usuario, se eliminan TODOS sus datos (perfil, medidas, planes, registros).

#### 2. Integridad de CatÃ¡logos
```
planes (DELETE)
  â†“ RESTRICT (no se puede eliminar si tiene asignaciones)
usuarios_planes (asignaciones activas)

comidas (DELETE)
  â†“ RESTRICT (no se puede eliminar si estÃ¡ en plan_dias o registros)
â”œâ”€â”€ plan_dias (planes que usan esta comida)
â””â”€â”€ registros_comidas (usuarios que la comieron)
```

**Regla:** No se pueden eliminar elementos del catÃ¡logo si estÃ¡n siendo usados.

#### 3. Composite Keys (Claves Compuestas)

**Tablas con Composite Keys:**
- `recetas`: `(id_comida, id_ingrediente)`
- `usuario_etiquetas_salud`: `(id_perfil, id_etiqueta)`
- `etiquetas_ingredientes`: `(id_ingrediente, id_etiqueta)`
- `etiquetas_ejercicios`: `(id_ejercicio, id_etiqueta)`
- `plan_etiquetas`: `(id_plan, id_etiqueta)`
- `rutina_etiquetas`: `(id_rutina, id_etiqueta)`

**Nota Importante:** En el cÃ³digo Java, estas tablas NO necesitan @IdClass ni entidades separadas si se mapean como @ManyToMany. La relaciÃ³n se gestiona automÃ¡ticamente.

---

## ğŸ’¼ MODELO DE NEGOCIO

### Roles de Usuario

#### 1. ROLE_USER (Usuarios Finales)
**Pueden:**
- âœ… Crear cuenta y perfil
- âœ… Ver catÃ¡logo de comidas, ingredientes, ejercicios
- âœ… Ver planes y rutinas disponibles
- âœ… Activar planes/rutinas para sÃ­ mismos
- âœ… Registrar comidas y ejercicios
- âœ… Ver su propio progreso
- âœ… Actualizar su perfil de salud

**NO pueden:**
- âŒ Crear/editar comidas, ingredientes, ejercicios
- âŒ Crear/editar planes o rutinas
- âŒ Ver datos de otros usuarios
- âŒ Acceder a panel de administraciÃ³n

#### 2. ROLE_ADMIN (Creadores de Contenido)
**Pueden:**
- âœ… Todo lo que puede ROLE_USER
- âœ… Crear/editar/eliminar ingredientes
- âœ… Crear/editar/eliminar comidas y recetas
- âœ… Crear/editar/eliminar ejercicios
- âœ… Crear/editar/eliminar planes nutricionales
- âœ… Crear/editar/eliminar rutinas de ejercicio
- âœ… Crear/editar etiquetas
- âœ… Ver estadÃ­sticas globales (cuÃ¡ntos usuarios usan cada plan)

**NO pueden:**
- âŒ Ver datos privados de usuarios (peso, registros personales)
- âŒ Modificar cuentas de otros usuarios

### Funcionalidades por Rol

**ROLE_USER (Usuarios/Clientes):**
```
â”œâ”€â”€ Acceso completo al catÃ¡logo de planes y rutinas
â”œâ”€â”€ Activar 1 plan nutricional y 1 rutina simultÃ¡neamente
â”œâ”€â”€ Registrar comidas y ejercicios (modo guiado o libre)
â”œâ”€â”€ Historial completo de medidas corporales
â”œâ”€â”€ Visualizar progreso y mÃ©tricas de adherencia
â”œâ”€â”€ Exportar reportes en PDF
â””â”€â”€ Gestionar perfil de salud (objetivos, alergias, condiciones)
```

**ROLE_ADMIN (Administradores/Nutricionistas):**
```
â”œâ”€â”€ Todas las funcionalidades de ROLE_USER
â”œâ”€â”€ Crear/editar/eliminar contenido del catÃ¡logo
â”œâ”€â”€ Gestionar etiquetas maestras del sistema
â”œâ”€â”€ DiseÃ±ar planes nutricionales completos
â”œâ”€â”€ DiseÃ±ar rutinas de ejercicio completas
â”œâ”€â”€ Ver estadÃ­sticas agregadas del sistema
â””â”€â”€ Panel de administraciÃ³n completo
```

---

## ğŸ¯ CASOS DE USO PRINCIPALES

### Caso 1: Creador de Contenido (Admin) Crea un Plan

```java
// 1. Admin crea un plan
Plan plan = Plan.builder()
    .nombre("Plan DefiniciÃ³n Muscular 45 dÃ­as")
    .descripcion("Plan de alta proteÃ­na para definiciÃ³n")
    .duracionDias(45)
    .activo(true)
    .build();
planRepository.save(plan);

// 2. Definir objetivos del plan
PlanObjetivo objetivo = PlanObjetivo.builder()
    .plan(plan)
    .caloriasObjetivo(1800.0)
    .proteinasObjetivo(150.0)
    .carbohidratosObjetivo(120.0)
    .grasasObjetivo(60.0)
    .descripcion("DÃ©ficit calÃ³rico moderado con alta proteÃ­na")
    .build();
planObjetivoRepository.save(objetivo);

// 3. Programar actividades dÃ­a a dÃ­a
for (int dia = 1; dia <= 45; dia++) {
    // Desayuno
    PlanDia desayuno = PlanDia.builder()
        .plan(plan)
        .numeroDia(dia)
        .tipoComida(TipoComida.DESAYUNO)
        .comida(getComidaParaDia(dia, TipoComida.DESAYUNO))
        .notas("Tomar con agua tibia")
        .build();
    
    // Almuerzo
    PlanDia almuerzo = PlanDia.builder()
        .plan(plan)
        .numeroDia(dia)
        .tipoComida(TipoComida.ALMUERZO)
        .comida(getComidaParaDia(dia, TipoComida.ALMUERZO))
        .build();
    
    // Cena
    PlanDia cena = PlanDia.builder()
        .plan(plan)
        .numeroDia(dia)
        .tipoComida(TipoComida.CENA)
        .comida(getComidaParaDia(dia, TipoComida.CENA))
        .build();
    
    planDiaRepository.saveAll(Arrays.asList(desayuno, almuerzo, cena));
}

// 4. Agregar etiquetas para bÃºsqueda
Etiqueta etiquetaDefinicion = etiquetaRepository.findByNombre("DefiniciÃ³n muscular");
Etiqueta etiquetaAltoProteina = etiquetaRepository.findByNombre("Alta proteÃ­na");
plan.agregarEtiqueta(etiquetaDefinicion);
plan.agregarEtiqueta(etiquetaAltoProteina);
planRepository.save(plan);

// Total: 1 plan + 1 objetivo + (45 dÃ­as x 3 comidas) = 136 registros
```

### Caso 2: Usuario Busca y Activa Plan Personalizado

```java
// 1. Usuario busca planes segÃºn sus necesidades
PerfilUsuario perfil = perfilUsuarioRepository.findByIdUsuario(userId);
UsuarioPerfilSalud salud = perfil.getPerfilSalud();

// Obtener etiquetas del usuario (alergias, objetivos)
List<Etiqueta> etiquetasUsuario = usuarioEtiquetasSaludRepository
    .findEtiquetasByPerfilId(perfil.getId());

// Buscar planes compatibles
List<Plan> planesRecomendados = planRepository.findPlanesCompatibles(
    salud.getObjetivoActual(),  // PERDER_PESO
    etiquetasUsuario,           // [Sin lactosa, Dieta mediterrÃ¡nea]
    salud.getNivelActividadActual()
);

// 2. Usuario ve detalle de un plan especÃ­fico
Plan planSeleccionado = planesRecomendados.get(0);
PlanObjetivo objetivos = planSeleccionado.getObjetivo();

// Mostrar preview de los primeros 3 dÃ­as
List<PlanDia> preview = planDiaRepository
    .findByPlanIdAndNumeroDiaBetween(planSeleccionado.getId(), 1, 3);

// 3. Usuario activa el plan
UsuarioPlan asignacion = UsuarioPlan.builder()
    .perfilUsuario(perfil)
    .plan(planSeleccionado)
    .fechaInicio(LocalDate.now())
    .fechaFin(LocalDate.now().plusDays(planSeleccionado.getDuracionDias()))
    .diaActual(1)
    .estado(EstadoAsignacion.ACTIVO)
    .notas("Empezando mi proceso de transformaciÃ³n")
    .build();
usuarioPlanRepository.save(asignacion);

// 4. Sistema notifica usuario
notificationService.send(
    userId,
    "Â¡Plan activado! Hoy es tu dÃ­a 1. Revisa tu menÃº del dÃ­a."
);
```

### Caso 3: Usuario Sigue el Plan DÃ­a a DÃ­a

```java
// Cada maÃ±ana, el sistema muestra el plan del dÃ­a
UsuarioPlan planActivo = usuarioPlanRepository.findActivoPorUsuario(userId);
int diaActual = planActivo.getDiaActual();

// Obtener actividades del dÃ­a
List<PlanDia> actividadesHoy = planDiaRepository
    .findByPlanIdAndNumeroDia(planActivo.getPlan().getId(), diaActual);

// Mostrar al usuario (ordenado por tipo de comida)
for (PlanDia actividad : actividadesHoy) {
    System.out.println(
        actividad.getTipoComida() + ": " + 
        actividad.getComida().getNombre() +
        (actividad.getNotas() != null ? " - " + actividad.getNotas() : "")
    );
}

// Usuario come el desayuno y registra
PlanDia desayunoPlaneado = actividadesHoy.stream()
    .filter(a -> a.getTipoComida() == TipoComida.DESAYUNO)
    .findFirst()
    .orElse(null);

RegistroComida registro = RegistroComida.builder()
    .perfilUsuario(planActivo.getPerfilUsuario())
    .usuarioPlan(planActivo)
    .comida(desayunoPlaneado.getComida())
    .fecha(LocalDate.now())
    .hora(LocalTime.now())
    .tipoComida(TipoComida.DESAYUNO)
    .porciones(BigDecimal.ONE)
    .caloriasConsumidas(calcularCalorias(desayunoPlaneado.getComida(), BigDecimal.ONE))
    .notas("Delicioso!")
    .build();
registroComidaRepository.save(registro);

// Al final del dÃ­a, avanzar al siguiente
if (todosLosRegistrosDelDiaCompletados()) {
    planActivo.setDiaActual(planActivo.getDiaActual() + 1);
    usuarioPlanRepository.save(planActivo);
    
    // Si completÃ³ todos los dÃ­as
    if (planActivo.getDiaActual() > planActivo.getPlan().getDuracionDias()) {
        planActivo.setEstado(EstadoAsignacion.COMPLETADO);
        usuarioPlanRepository.save(planActivo);
        
        notificationService.send(
            userId,
            "Â¡Felicidades! Completaste el plan. Â¿Listo para el siguiente desafÃ­o?"
        );
    }
}
```

### Caso 4: Dashboard de Progreso

```java
// MÃ©tricas de adherencia
AdherenciaDTO adherencia = calcularAdherencia(userId, planActivo.getId());

class AdherenciaDTO {
    int diasTotales = planActivo.getPlan().getDuracionDias();
    int diasRegistrados = registroComidaRepository.countDiasConRegistros(planActivo.getId());
    int comidasPlaneadas = diasTotales * 4; // 4 comidas por dÃ­a
    int comidasRegistradas = registroComidaRepository.countByUsuarioPlan(planActivo.getId());
    
    double adherenciaPorcentaje = (diasRegistrados * 100.0) / diasTotales;
    double completitudPorcentaje = (comidasRegistradas * 100.0) / comidasPlaneadas;
}

// MÃ©tricas nutricionales
NutricionDTO nutricion = calcularPromedioNutricional(planActivo.getId());

class NutricionDTO {
    BigDecimal caloriasObjetivo = planActivo.getPlan().getObjetivo().getCaloriasObjetivo();
    BigDecimal caloriasPromedio = registroComidaRepository.avgCalorias(planActivo.getId());
    BigDecimal desviacion = caloriasPromedio.subtract(caloriasObjetivo);
    
    BigDecimal proteinasObjetivo = planActivo.getPlan().getObjetivo().getProteinasObjetivo();
    BigDecimal proteinasPromedio = calcularPromedioProteinas();
    
    boolean cumpleObjetivos = 
        caloriasPromedio.compareTo(caloriasObjetivo.multiply(BigDecimal.valueOf(1.05))) <= 0 &&
        caloriasPromedio.compareTo(caloriasObjetivo.multiply(BigDecimal.valueOf(0.95))) >= 0;
}

// Progreso de peso
List<MedidaCorporal> historial = historialMedidasRepository
    .findByPerfilUsuarioIdOrderByFechaMedicionDesc(userId);

if (historial.size() >= 2) {
    MedidaCorporal actual = historial.get(0);
    MedidaCorporal inicial = historial.get(historial.size() - 1);
    
    BigDecimal perdidaPeso = inicial.getPeso().subtract(actual.getPeso());
    BigDecimal diasTranscurridos = ChronoUnit.DAYS.between(inicial.getFechaMedicion(), actual.getFechaMedicion());
    BigDecimal perdidaSemanal = perdidaPeso.divide(diasTranscurridos, 2, RoundingMode.HALF_UP).multiply(BigDecimal.valueOf(7));
    
    System.out.println("Peso inicial: " + inicial.getPeso() + " kg");
    System.out.println("Peso actual: " + actual.getPeso() + " kg");
    System.out.println("PÃ©rdida total: " + perdidaPeso + " kg");
    System.out.println("PÃ©rdida semanal promedio: " + perdidaSemanal + " kg/semana");
}
```

---

## âš–ï¸ DIFERENCIAS CLAVE VS OTROS SISTEMAS

### âŒ Lo que NutriTrack NO es:

1. **NO es un contador de calorÃ­as simple** (como MyFitnessPal bÃ¡sico)
    - No solo registras lo que comes
    - Te da un PLAN COMPLETO dÃ­a a dÃ­a

2. **NO es un catÃ¡logo de "metas sueltas"**
    - No escoges metas individuales como: "Perder peso", "Hacer cardio"
    - Escoges PLANES COMPLETOS que ya tienen todo programado

3. **NO permite crear planes personalizados al usuario final**
    - Los usuarios ESCOGEN planes pre-creados por admins
    - No pueden modificar las actividades del plan (solo seguirlas)

4. **NO es un sistema de seguimiento libre sin estructura**
    - Todo registro puede vincularse a un plan activo
    - Hay diferencia entre seguir un plan vs registrar libremente

### âœ… Lo que NutriTrack SÃ es:

1. **Sistema de Coaching Guiado**
   ```
   Usuario: "Quiero perder peso"
   Sistema: "AquÃ­ tienes 5 planes de 30 dÃ­as que te guiarÃ¡n dÃ­a a dÃ­a"
   Usuario: Escoge uno
   Sistema: "Hoy dÃ­a 5, come: Desayuno X, Almuerzo Y, Cena Z"
   Usuario: Registra lo que comiÃ³
   Sistema: "Llevas 85% de adherencia, vas excelente"
   ```

2. **SeparaciÃ³n Clara de Responsabilidades**
   ```
   ADMINS (Nutricionistas/Entrenadores):
   - Crean catÃ¡logo de ingredientes, comidas, ejercicios
   - DiseÃ±an planes nutricionales completos
   - DiseÃ±an rutinas de ejercicio completas
   - Definen objetivos y macros
   
   USUARIOS (Clientes):
   - Escogen planes/rutinas pre-diseÃ±ados
   - Siguen las actividades dÃ­a a dÃ­a
   - Registran su cumplimiento
   - Ven su progreso
   ```

3. **Dual Mode: Guiado vs Libre**
   ```
   MODO GUIADO (recomendado):
   - Usuario tiene plan activo
   - Registros vinculan a usuarios_planes
   - Sistema compara plan vs realidad
   - MÃ©tricas de adherencia disponibles
   
   MODO LIBRE:
   - Usuario sin plan activo
   - Registros sin vincular a plan
   - Solo seguimiento bÃ¡sico de calorÃ­as
   - Sin mÃ©tricas de adherencia
   ```

4. **Sistema de Progreso AutomÃ¡tico**
   ```
   Planes: dia_actual se incrementa automÃ¡ticamente
   Rutinas: semana_actual se incrementa
   Sistema siempre sabe en quÃ© punto estÃ¡ el usuario
   ```

---

## ğŸ“œ REGLAS DE NEGOCIO CRÃTICAS

### Regla 1: Un Plan es Inmutable una vez Activado

```
PROBLEMA: Â¿QuÃ© pasa si un admin edita un plan que ya estÃ¡ siendo usado?

SOLUCIÃ“N: Versioning implÃ­cito
- Cuando usuario activa plan, se guarda una "foto" del plan
- Si admin modifica plan original, NO afecta asignaciones activas
- usuarios_planes apunta a planes.id que no cambia
- plan_dias vincula a plan.id, pero los registros apuntan a usuarios_planes

IMPLEMENTACIÃ“N:
- NO eliminar plan_dias si hay usuarios_planes activos
- Marcar plan.activo = false en vez de eliminar
- Crear nueva versiÃ³n del plan si se requiere modificaciÃ³n mayor
```

### Regla 2: Progreso DÃ­a/Semana se Incrementa Solo

```
NUNCA permitir que usuario modifique dia_actual o semana_actual manualmente

TRIGGERS PERMITIDOS:
1. Usuario completa todos los registros del dÃ­a
   â†’ dia_actual++
2. Usuario marca dÃ­a como "saltado"
   â†’ dia_actual++ pero con nota
3. Administrador puede ajustar en casos excepcionales
4. Sistema automÃ¡tico al cambio de fecha (cron job)
```

### Regla 3: Integridad Nutricional

```
calorias_consumidas DEBE calcularse automÃ¡ticamente:

calorias_consumidas = SUM(
    ingrediente.energia * 
    receta.cantidad_ingrediente / 100 * 
    registro.porciones
) FOR ALL ingredientes IN comida

NUNCA permitir entrada manual de calorÃ­as
```

### Regla 4: Estado de Asignaciones

```
Estados permitidos: ACTIVO | COMPLETADO | CANCELADO | PAUSADO

Transiciones vÃ¡lidas:
  ACTIVO â†’ COMPLETADO (al llegar a duracion_dias/semanas)
  ACTIVO â†’ CANCELADO (usuario abandona)
  ACTIVO â†’ PAUSADO (usuario pausa temporalmente)
  PAUSADO â†’ ACTIVO (usuario reanuda)
  
Transiciones PROHIBIDAS:
  COMPLETADO â†’ ACTIVO (no se puede reactivar un plan completado)
  CANCELADO â†’ ACTIVO (debe crear nueva asignaciÃ³n)
```

### Regla 5: GestiÃ³n de MÃºltiples Planes/Rutinas

```
REGLA DE NEGOCIO:
- Usuario puede tener MÃšLTIPLES planes y rutinas activos simultÃ¡neamente
- NO puede activar el MISMO plan/rutina dos veces si ya lo tiene ACTIVO
- Para volver a iniciar el MISMO plan/rutina:
  â†’ Debe PAUSAR o CANCELAR la instancia anterior primero
- Puede tener:
  âœ… Plan A (ACTIVO) + Plan B (ACTIVO) â†’ Diferentes planes simultÃ¡neos OK
  âœ… Rutina X (ACTIVO) + Rutina Y (ACTIVO) â†’ Diferentes rutinas simultÃ¡neas OK
  âœ… Plan A (ACTIVO) + Plan A (PAUSADO) â†’ Mismo plan, diferente estado OK
  âŒ Plan A (ACTIVO) + Plan A (ACTIVO) â†’ Duplicado NO permitido

VALIDACIÃ“N:
Before INSERT INTO usuarios_planes (nuevo plan):
  // Verificar si el MISMO plan ya estÃ¡ ACTIVO
  IF EXISTS (
    SELECT 1 FROM usuarios_planes up
    WHERE up.id_perfil_usuario = X 
    AND up.id_plan = Y                    // MISMO plan
    AND up.estado = 'ACTIVO'
  ) THEN
    MOSTRAR DIÃLOGO: "Ya tienes este plan activo. Â¿Deseas pausarlo/cancelarlo para reiniciarlo?"
    - SI confirma â†’ Cambiar instancia anterior a PAUSADO, crear nueva instancia como ACTIVO
    - NO â†’ No hacer nada
  END IF

Before INSERT INTO usuarios_rutinas (nueva rutina):
  // Verificar si la MISMA rutina ya estÃ¡ ACTIVA
  IF EXISTS (
    SELECT 1 FROM usuarios_rutinas ur
    WHERE ur.id_perfil_usuario = X 
    AND ur.id_rutina = Z                  // MISMA rutina
    AND ur.estado = 'ACTIVO'
  ) THEN
    MOSTRAR DIÃLOGO: "Ya tienes esta rutina activa. Â¿Deseas pausarla/cancelarla para reiniciarla?"
    - SI confirma â†’ Cambiar instancia anterior a PAUSADO, crear nueva instancia como ACTIVO
    - NO â†’ No hacer nada
  END IF

EJEMPLOS VÃLIDOS:
Usuario puede tener simultÃ¡neamente:
- Plan "PÃ©rdida de Peso 30 dÃ­as" (ACTIVO)
- Plan "DefiniciÃ³n Muscular 45 dÃ­as" (ACTIVO)
- Rutina "Hipertrofia 12 semanas" (ACTIVO)
- Rutina "Cardio Intensivo 8 semanas" (ACTIVO)

EJEMPLO INVÃLIDO:
Usuario NO puede tener:
- Plan "PÃ©rdida de Peso 30 dÃ­as" (ACTIVO, dÃ­a 5)
- Plan "PÃ©rdida de Peso 30 dÃ­as" (ACTIVO, dÃ­a 1) âŒ Duplicado
```

### Regla 6: Privacidad de Datos

```
USUARIOS pueden ver:
- âœ… Su propio perfil, medidas, registros
- âœ… CatÃ¡logo pÃºblico (comidas, ejercicios, planes, rutinas)

USUARIOS NO pueden ver:
- âŒ Datos de otros usuarios
- âŒ EstadÃ­sticas de uso de planes por otros
- âŒ Panel de administraciÃ³n

ADMINS pueden ver:
- âœ… CatÃ¡logo completo (crear/editar)
- âœ… EstadÃ­sticas agregadas (cuÃ¡ntos usuarios usan plan X)

ADMINS NO pueden ver:
- âŒ Datos personales de usuarios (peso, registros individuales)
- âŒ InformaciÃ³n mÃ©dica de usuarios
```

### Regla 7: EliminaciÃ³n de Datos

```
SOFT DELETE (marcar como inactivo):
- Planes: activo = false
- Rutinas: activo = false
- Comidas: soft delete con flag is_deleted
- Ejercicios: soft delete con flag is_deleted

HARD DELETE (eliminaciÃ³n fÃ­sica):
- Registros de usuarios (por solicitud GDPR)
- Cuentas de usuarios inactivos > 2 aÃ±os

CASCADE DELETE:
- cuentas_auth â†’ perfiles_usuario â†’ TODO lo del usuario
```

### Regla 8: ValidaciÃ³n de Recetas

```
Una comida DEBE tener al menos 1 ingrediente:

Before INSERT INTO comidas:
  No validaciÃ³n aquÃ­ (comida puede existir sin receta temporalmente)

Before SET comida.activo = true:
  IF COUNT(recetas WHERE id_comida = X) < 1
  THEN REJECT "Una comida debe tener al menos un ingrediente"
```

### Regla 9: Coherencia de Fechas

```
usuarios_planes:
  fecha_fin DEBE SER fecha_inicio + duracion_dias

usuarios_rutinas:
  fecha_fin DEBE SER fecha_inicio + (duracion_semanas * 7)

registros_comidas:
  fecha DEBE estar entre fecha_inicio y fecha_fin del plan
  (si estÃ¡ vinculado a un plan)

usuario_historial_medidas:
  NO permitir fecha_medicion en el futuro
```

### Regla 10: Unidades de Medida Consistentes

```
perfiles_usuario.unidades_medida = 'KG' | 'LBS'

ALL peso fields DEBEN almacenarse en base de datos en KG
ALL altura fields DEBEN almacenarse en CM

CONVERSION en API Layer:
- Input: Usuario envÃ­a en su unidad preferida
- Storage: Convertir a KG/CM para almacenar
- Output: Convertir a unidad preferida del usuario
```

---

## ğŸ“ RESUMEN EJECUTIVO

### Para Desarrolladores Nuevos:

**Cuando construyas o mantengas este proyecto, recuerda:**

1. **Planes y Rutinas son OBJETIVOS COMPLETOS, no actividades sueltas**
    - Un plan contiene TODAS las actividades de todos los dÃ­as
    - Usuario escoge el plan completo, no arma su propio plan

2. **Hay 3 niveles de datos:**
    - **CATÃLOGO**: Templates reutilizables (planes, rutinas, comidas, ejercicios)
    - **ASIGNACIÃ“N**: Usuario activa un template (usuarios_planes, usuarios_rutinas)
    - **REGISTRO**: Usuario reporta lo que hizo (registros_comidas, registros_ejercicios)

3. **Sistema de Etiquetas es TRANSVERSAL:**
    - Una tabla `etiquetas` categoriza TODO
    - 7 tipos diferentes de etiquetas
    - Permite bÃºsqueda y filtrado muy flexible

4. **Progreso es AUTOMÃTICO:**
    - `dia_actual` y `semana_actual` se incrementan automÃ¡ticamente
    - Estados cambian automÃ¡ticamente (ACTIVO â†’ COMPLETADO)
    - Usuario solo registra, sistema calcula progreso

5. **Modo Dual: Guiado vs Libre:**
    - Con plan activo: registros vinculados, mÃ©tricas de adherencia
    - Sin plan activo: registro libre, solo seguimiento bÃ¡sico

### Para Product Owners:

**El valor del sistema estÃ¡ en:**

1. **Expertise Encapsulado:** Nutricionistas/entrenadores crean planes profesionales que usuarios finales siguen
2. **GuÃ­a DÃ­a a DÃ­a:** No mÃ¡s "Â¿quÃ© como hoy?", el plan lo dice claramente
3. **Accountability:** Sistema compara plan vs realidad, genera mÃ©tricas objetivas
4. **Escalabilidad:** Un plan creado = infinitos usuarios pueden usarlo
5. **Enfoque Educativo:** Proyecto completo con todas las funcionalidades disponibles para aprendizaje prÃ¡ctico

---

## ğŸ“š REFERENCIAS TÃ‰CNICAS

### Stack TecnolÃ³gico

- **Backend:** Spring Boot 3.5.7, Java 21
- **ORM:** Hibernate 6.6.33 (JPA)
- **Database:** PostgreSQL 16.10
- **Auth:** JWT Bearer Token
- **API Docs:** Swagger/OpenAPI 3.0
- **Build:** Maven

### Archivos Clave

```
SQL/NutriDB.sql                  â†’ Schema completo de base de datos
src/main/java/com/.../model/     â†’ Entidades JPA
src/main/java/com/.../dto/       â†’ Data Transfer Objects
src/main/java/com/.../service/   â†’ LÃ³gica de negocio
src/main/java/com/.../controller/â†’ API REST endpoints
```

### Documentos Relacionados

- **[USER_STORIES.MD](./USER_STORIES.MD)** - Las 25 User Stories que definen la funcionalidad del sistema
- **[REGLAS_NEGOCIO.MD](./REGLAS_NEGOCIO.MD)** - Las 24 reglas de negocio que deben implementarse

### Endpoints Principales

```
POST   /api/v1/auth/registro      â†’ Crear cuenta
POST   /api/v1/auth/login         â†’ Iniciar sesiÃ³n
GET    /api/v1/planes              â†’ Listar planes disponibles
POST   /api/v1/usuarios-planes    â†’ Activar un plan
GET    /api/v1/planes/{id}/dias/{dia} â†’ Ver actividades del dÃ­a
POST   /api/v1/registros-comidas  â†’ Registrar comida
GET    /api/v1/usuarios-planes/{id}/progreso â†’ Ver progreso
```

---

**Ãšltima ActualizaciÃ³n:** 4 de Noviembre, 2025  
**VersiÃ³n del Documento:** 1.0  
**PropÃ³sito:** DocumentaciÃ³n base del modelo de negocio NutriTrack

---

> **ğŸ’¡ Nota:** Este documento describe el modelo de negocio y la arquitectura del sistema. Es la referencia principal para entender cÃ³mo funciona NutriTrack y sus reglas de negocio fundamentales.